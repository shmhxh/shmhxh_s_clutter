name: Build Python Applications

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            python-version: '3.8'
            architecture: 'x86'
          - os: ubuntu-latest
            python-version: '3.8'
            architecture: 'x64'
          - os: macos-latest
            python-version: '3.9'
            architecture: 'x64'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python for Windows/Linux
      if: matrix.os != 'macos-latest'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}
    
    - name: Install and set up Python for macOS
      if: matrix.os == 'macos-latest'
      run: |
        # 安装依赖
        brew install gettext
        
        # 安装Python 3.9并确保链接
        brew install python@3.9
        brew link --overwrite python@3.9
        
        # 直接在当前shell中设置环境变量（使用正确的Homebrew路径）
        export PATH="/opt/homebrew/opt/python@3.9/bin:$PATH"
        export LDFLAGS="-L/opt/homebrew/opt/gettext/lib"
        export CPPFLAGS="-I/opt/homebrew/opt/gettext/include"
        
        # 立即安装pip
        /opt/homebrew/opt/python@3.9/bin/python3 -m ensurepip
        /opt/homebrew/opt/python@3.9/bin/python3 -m pip install --upgrade pip
      shell: bash
    
    - name: Install dependencies for Windows/Linux
      if: matrix.os != 'macos-latest'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if [ -f python_toolbox/requirements.txt ]; then pip install -r python_toolbox/requirements.txt; fi
      shell: bash
    
    - name: Install dependencies for macOS
      if: matrix.os == 'macos-latest'
      run: |
        # 直接使用brew安装的Python路径
        PYTHON_PATH="/opt/homebrew/opt/python@3.9/bin/python3"
        PIP_PATH="/opt/homebrew/opt/python@3.9/bin/pip3"
        
        # 确保pip是最新版本
        $PYTHON_PATH -m pip install --upgrade pip
        
        # 安装PyInstaller
        $PIP_PATH install pyinstaller
        
        # 安装项目依赖
        if [ -f python_toolbox/requirements.txt ]; then $PIP_PATH install -r python_toolbox/requirements.txt; fi
      shell: bash
        
    - name: Build for Windows
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name python_toolbox_gui python_toolbox_gui.py
        pyinstaller --onefile --windowed --name simple_gui_fixed simple_gui_fixed.py
        pyinstaller --onefile --windowed --name minimal_gui minimal_gui.py
    
    - name: Build for Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        pyinstaller --onefile --name python_toolbox_gui python_toolbox_gui.py
        pyinstaller --onefile --name simple_gui_fixed simple_gui_fixed.py
        pyinstaller --onefile --name minimal_gui minimal_gui.py
    
    - name: Build for macOS
      if: matrix.os == 'macos-latest'
      run: |
        # 使用brew安装的Python和PyInstaller
        /opt/homebrew/opt/python@3.9/bin/python3 -m PyInstaller --onefile --windowed --name python_toolbox_gui python_toolbox_gui.py
        /opt/homebrew/opt/python@3.9/bin/python3 -m PyInstaller --onefile --windowed --name simple_gui_fixed simple_gui_fixed.py
        /opt/homebrew/opt/python@3.9/bin/python3 -m PyInstaller --onefile --windowed --name minimal_gui minimal_gui.py
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-toolbox-${{ matrix.os }}
        path: |
          dist/

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/python-toolbox-windows-latest/python_toolbox_gui.exe
          artifacts/python-toolbox-windows-latest/simple_gui_fixed.exe
          artifacts/python-toolbox-windows-latest/minimal_gui.exe
          artifacts/python-toolbox-ubuntu-latest/python_toolbox_gui
          artifacts/python-toolbox-ubuntu-latest/simple_gui_fixed
          artifacts/python-toolbox-ubuntu-latest/minimal_gui
          artifacts/python-toolbox-macos-latest/python_toolbox_gui
          artifacts/python-toolbox-macos-latest/simple_gui_fixed
          artifacts/python-toolbox-macos-latest/minimal_gui
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}